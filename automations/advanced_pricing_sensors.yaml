# HomeWizard Battery Dynamic Control Automation
# Author: Joost Smits
# Version: 0.8, 29 November 2025
# License: MIT
# Repository: https://github.com/eurojojo/homewizard-dynamic-battery
#
# This automation controls the HomeWizard Plug-In Battery using
# ENTSO-e percentile thresholds (Q1/Q3), combined with PV export,
# grid load and profitability logic.

template:
  - sensor:

      # Local prices today as list of time/price in local timezone
      - name: "ENTSO-e prices today (local list)"
        unique_id: entso_e_prices_today_local_list
        icon: mdi:clock-time-four
        state: "ok"
        attributes:
          prices_today: >
            {% set prices = state_attr('sensor.entso_e_average_electricity_price', 'prices') or [] %}
            {% if not prices %}
              []
            {% else %}
              {% set today_start = as_timestamp(today_at('00:00')) %}
              {% set tomorrow_start = today_start + 86400 %}
              {% set ns = namespace(items=[]) %}

              {% for p in prices %}
                {% set dt_utc = as_datetime(p.time) %}
                {% if dt_utc is not none %}
                  {% set dt_local = as_local(dt_utc) %}
                  {% set ts = as_timestamp(dt_local) %}
                  {% if today_start <= ts < tomorrow_start %}
                    {% set ns.items = ns.items + [ {
                      'time': dt_local.isoformat(),
                      'price': p.price
                    } ] %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              {{ ns.items }}
            {% endif %}

      # Min price today (based on local prices_today list)
      - name: "ENTSO-e min price today"
        unique_id: entso_e_min_price_today
        unit_of_measurement: "€/kWh"
        state: >
          {% set prices = state_attr('sensor.entso_e_prices_today_local_list', 'prices_today') %}
          {% if not prices %}
            unknown
          {% else %}
            {% set vals = prices
              | map(attribute='price')
              | select('number')
              | list %}
            {% if vals | length == 0 %}
              unknown
            {% else %}
              {{ vals | min }}
            {% endif %}
          {% endif %}

      # Max price today (based on local prices_today list)
      - name: "ENTSO-e max price today"
        unique_id: entso_e_max_price_today
        unit_of_measurement: "€/kWh"
        state: >
          {% set prices = state_attr('sensor.entso_e_prices_today_local_list', 'prices_today') %}
          {% if not prices %}
            unknown
          {% else %}
            {% set vals = prices
              | map(attribute='price')
              | select('number')
              | list %}
            {% if vals | length == 0 %}
              unknown
            {% else %}
              {{ vals | max }}
            {% endif %}
          {% endif %}

      # Low price threshold ≈ Q1 (25th percentile, based on local prices_today list)
      - name: "ENTSO-e low price threshold"
        unique_id: entso_e_low_price_threshold
        unit_of_measurement: "€/kWh"
        state: >
          {% set prices = state_attr('sensor.entso_e_prices_today_local_list', 'prices_today') %}
          {% if not prices %}
            unknown
          {% else %}
            {% set vals = prices
              | map(attribute='price')
              | select('number')
              | list %}
            {% set n = vals | length %}
            {% if n < 2 %}
              unknown
            {% else %}
              {% set sorted = vals | sort %}
              {# Approximate 25th percentile (Q1) #}
              {% set idx = (0.25 * (n - 1)) | int %}
              {{ sorted[idx] }}
            {% endif %}
          {% endif %}

      # High price threshold ≈ Q3 (75th percentile, based on local prices_today list)
      - name: "ENTSO-e high price threshold"
        unique_id: entso_e_high_price_threshold
        unit_of_measurement: "€/kWh"
        state: >
          {% set prices = state_attr('sensor.entso_e_prices_today_local_list', 'prices_today') %}
          {% if not prices %}
            unknown
          {% else %}
            {% set vals = prices
              | map(attribute='price')
              | select('number')
              | list %}
            {% set n = vals | length %}
            {% if n < 2 %}
              unknown
            {% else %}
              {% set sorted = vals | sort %}
              {# Approximate 75th percentile (Q3) #}
              {% set idx = (0.75 * (n - 1)) | int %}
              {{ sorted[idx] }}
            {% endif %}
          {% endif %}

      # High price outlier threshold (Q3 + 1.5 * IQR)
      - name: "ENTSO-e high price outlier threshold"
        unique_id: entso_e_high_outlier_threshold
        unit_of_measurement: "€/kWh"
        state: >
          {% set q1_state = states('sensor.entso_e_low_price_threshold') %}
          {% set q3_state = states('sensor.entso_e_high_price_threshold') %}
          {% if q1_state in ['unknown', 'unavailable', 'none', '']
                or q3_state in ['unknown', 'unavailable', 'none', ''] %}
            unknown
          {% else %}
            {% set q1 = q1_state | float %}
            {% set q3 = q3_state | float %}
            {% set iqr = q3 - q1 %}
            {{ q3 + 1.5 * iqr }}
          {% endif %}

      # Round-trip profit for today (based on those min/max)
      - name: "ENTSO-e round trip profit today"
        unique_id: entso_e_round_trip_profit_today
        unit_of_measurement: "€/kWh"
        state: >
          {% set tax = 0.14 %}
          {% set lowest = states('sensor.entso_e_min_price_today') | float(0) %}
          {% set highest = states('sensor.entso_e_max_price_today') | float(0) %}
          {% if lowest == 0 and highest == 0 %}
            unknown
          {% else %}
            {{ (highest + tax) * 0.75 - (lowest + tax) }}
          {% endif %}
